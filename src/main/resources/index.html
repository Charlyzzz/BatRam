<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carrier monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>
<body>

<div style="width:75%;">
    <canvas id="canvas"></canvas>
</div>

<script>
  const chartColors = {
    0: 'rgb(255, 99, 132)',
    1: 'rgb(255, 159, 64)',
    2: 'rgb(255, 205, 86)',
    3: 'rgb(75, 192, 192)',
    4: 'rgb(54, 162, 235)',
    5: 'rgb(153, 102, 255)',
    6: 'rgb(201, 203, 207)'
  };


  const createDataset = (name, color) => {
    return {
      label: name,
      backgroundColor: color,
      borderColor: color,
      data: [],
      fill: false
    };
  };

  /*
  let datasets = [{
    label: 'My First dataset',
    backgroundColor: chartColors.red,
    borderColor: chartColors.red,
    data,
    fill: false
  }];
   */

  const config = {
    type: 'line',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Chart.js Line Chart'
      },
      tooltips: {
        mode: 'index',
        intersect: false
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        x: {
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Month'
          }
        },
        y: {
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Value'
          }
        }
      }
    }
  };


  window.onload = function () {
    const ctx = document.getElementById('canvas').getContext('2d');
    const myLine = new Chart(ctx, config);

    const addValue = (n, v) => {

      const { data } = config.data.datasets.find(d => d.label === n);
      data.push(v);
      console.log(config.data.labels.length)
      if (config.data.labels.length > 50) {
        config.data.labels.shift();
        data.shift();
      }else {
        config.data.labels.push('');
      }
      myLine.update();
    };
    const addresses = [];
    const evtSource = new EventSource('metrics');
    evtSource.onmessage = (sse) => {
      try {
        const { rps, address } = JSON.parse(sse.data);
        if (addresses.indexOf(address) === -1) {
          const index = addresses.push(address) - 1;
          config.data.datasets.push(createDataset(address, chartColors[0]));
        }
        addValue(address, parseInt(rps));

      } catch (e) {
        console.error(e);
      }
    };
  };
</script>
</body>
</html>